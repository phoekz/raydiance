<!doctype html>
<html lang="en">
<head>
    <title>Raydiance - Blog</title>
    <meta charset="utf-8">
    <meta name="theme-color" content="#ff8c00">
    <meta property="og:title" content="Raydiance - Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://phoekz.github.io/raydiance/blog/" />
    <meta property="og:image" content="https://phoekz.github.io/raydiance/blog/media/preview.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
    <style>/*
 * Constants
 */

:root {
    --theme-color: darkorange;
    --light-color: #666;
    --max-page-width: 800px;
    --font-regular: "Source Sans Pro - Regular";
    --font-title: "Source Sans Pro - SemiBold";
    --font-code: "Source Code Pro";
}

/*
 * Fonts
 */

@font-face {
    font-family: "Source Sans Pro - Regular";
    src: url("fonts/SourceSansPro-Regular.ttf") format("truetype");
}

@font-face {
    font-family: "Source Sans Pro - SemiBold";
    src: url("fonts/SourceSansPro-SemiBold.ttf") format("truetype");
}

@font-face {
    font-family: "Source Code Pro";
    src: url("fonts/SourceCodePro-Regular.ttf") format("truetype");
}

h1,
h2,
h3 {
    font-family: var(--font-title);

    /* iOS renders headings extra bolded for some reason. This font-weight is
    used to make it look the same as desktop browser. */
    font-weight: 400;
}

p,
li,
svg,
article-date,
article-caption-image,
footer-github,
footer-copyright {
    font-family: var(--font-regular);
}

code {
    font-family: var(--font-code);
}

/*
 * Main elements
 */

a {
    /* Remove underlines */
    text-decoration: none;

    /* Coloring */
    color: var(--theme-color);
}

img {
    /* Prevent images from overflowing from the body */
    max-width: var(--max-page-width);
}

body {
    /* Prevents the page to spread out too wide */
    max-width: var(--max-page-width);

    /* Center page */
    margin: 0 auto;

    /* Improve text readability */
    line-height: 1.5;
    font-size: 18px;
}

footer {
    /* Give footer some breathing room */
    margin: 10px;
    padding-bottom: 30px;
}

footer-github {
    /* Force GitHub link to the left */
    float: left;
}

footer-copyright {
    /* Force copyright to the right */
    text-align: right;
    float: right;
}

/*
 * Article
 */

article-date {
    color: var(--light-color);
}

article-image {
    display: grid;
    grid-template-columns: 1fr;
}

article-image-pair {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
}

article-caption-image {
    text-align: center;
    font-size: 0.8em;
}

article-commit {
    font-size: 14px;
    color: var(--light-color);
}</style>
</head>
<body>
    <header><h1>Raydiance - Blog</h1></header><hr>
    <section><h1 id="new-skylight-model"><a href="#new-skylight-model">New skylight model, tone mapping, new visualizations</a></h1>
<article>
    <article-date>2023-02-09</article-date>
    <article-content><p><info
title="New skylight model, tone mapping, new visualizations"
link="new-skylight-model"
date="2023-02-09"
commit="9f73353bd3de949b4268f628979847b141ad7d59"
/></p>
<video width="800" height="450" autoplay loop muted playsinline>
    <source src="media/new-skylight-model/title-h265.mp4" type="video/mp4" />
    <source src="media/new-skylight-model/title-vp9.webm" type="video/webm" />
</video>
<p>This release implements a new skylight model, tone mapping, and a simple
keyframe animation system. This release also unifies all visualization systems
under a single set of tools.</p>
<h1>Hosek-Wilkie skylight model</h1>
<p>Our previous lighting was a straightforward ad-hoc directional light which we
defined as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.75em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">0.5∣</span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>In this release, we replaced it with <a href="https://cgg.mff.cuni.cz/projects/SkylightModelling/">An Analytic Model for Full Spectral
Sky-Dome Radiance</a> by Lukas Hosek and Alexander Wilkie. This paper
proposes a physically-based analytical model for dynamic daytime skydomes. We
can now animate the sun's position in real-time and have the model produce
realistic sunsets.</p>
<p>The authors wrote a brute-force path tracing simulation for gathering reference
data on atmospheric scattering. They used this reference data to create the
following model.</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:12.0541em;vertical-align:-5.7771em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.2771em;"><span style="top:-8.9282em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">λ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-7.4282em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">λ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.7447em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord mathbf">F</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">)</span></span></span><span style="top:-3.5936em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord mathnormal">χ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">)</span></span></span><span style="top:-1.374em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span><span style="top:0.126em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span><span style="top:1.626em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord text"><span class="mord">A,B</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.7771em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.2771em;"><span style="top:-8.9282em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">spectral radiance</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathbf">F</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">λ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-7.4282em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">expected value of spectral radiance</span></span></span></span><span style="top:-5.7447em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">A</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">c</span><span class="mtight">o</span><span class="mtight">s</span></span><span class="mspace mtight" style="margin-right:0.2453em;"></span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="mbin mtight">+</span><span class="mord mtight">0.01</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4035em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">E</span><span class="mord mathnormal mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">cos</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">G</span><span class="mord mathnormal">χ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">cos</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.004em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span><span style="top:-3.5936em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.1704em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9396em;"><span style="top:-3.3486em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop"><span class="mop">cos</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0796em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.374em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">angle between view and sun directions</span></span></span></span><span style="top:0.126em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">angle between view and the zenith</span></span></span></span><span style="top:1.626em;"><span class="pstrut" style="height:3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">model parameters</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.7771em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>To evaluate the model, we query the model parameters <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span></span></span></span> and
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mord mathnormal mtight">λ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> from the datasets provided by the authors. Since our renderer
only supports RGB, we must use their RGB datasets.</p>
<p>The sky model runs fast enough to be interactive. Here's a short real-time
demonstration:</p>
<video width="800" height="450" autoplay loop muted playsinline>
    <source src="media/new-skylight-model/editor-demo-h265.mp4" type="video/mp4" />
    <source src="media/new-skylight-model/editor-demo-vp9.webm" type="video/webm" />
</video>
<h1>Implementation details</h1>
<p>The original implementation is implemented ~1000 lines of ANSI C. We could have
built it into our Rust project, but we realized that most of the code was
useless. We re-implemented the original C version into Rust with the following
changes:</p>
<ul>
<li>We removed spectral and CIE XYZ data sets since our renderer only support
RGB.</li>
<li>We removed the solar radiance functionality since its API only supported
spectral radiances. However, having a solar disc increases realism, so we
might have to revisit this later.</li>
<li>We removed the &quot;Alien World&quot; functionality since we are only concerned with
terrestrial skies.</li>
<li>We switched from double-precision to single-precision computations and
storage. Reduced precision did not seem to have any visual impact and
performed better than doubles.</li>
<li>The model state size went down from 1088 bytes to only 120 bytes.</li>
</ul>
<p>With these changes, our implementation ended up being just ~200 LOC of Rust.</p>
<h1>Simple exposure control</h1>
<p><img src="media/new-skylight-model/exposure.apng" alt="" /></p>
<p>With the new skylight model, we now have a problem: the scene is too bright. We
can scale the brightness down by a constant factor called <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span></span></span></span>, which we
are going to define as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7196em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span></p>
<p>We apply this scaling to every pixel as the final step of the render.</p>
<h1>Tone mapping</h1>
<article-image-pair>
    <article-caption-image>
        <img src="media/new-skylight-model/tonemap-compare-dim.apng" width="100%"/>
        Dim scene
    </article-caption-image>
    <article-caption-image>
        <img src="media/new-skylight-model/tonemap-compare-bright.apng" width="100%"/>
        Bright scene
    </article-caption-image>
</article-image-pair>
<p>We can make the image &quot;pop&quot; more with <em>tone mapping</em>, which is a technique for
mapping high-dynamic range (HDR) images into low-dynamic range (LDR) to be shown
on a display device. Our implementation uses the &quot;ACES Filmic Tone Mapping
Curve,&quot; which is currently the default tone mapping curve in Unreal Engine. More
specifically, we used <a href="https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/">Krzysztof Narkowicz's simple curve fit</a>, which
seemed simple, fast enough, and visually pleasing.</p>
<p><svg width="800" height="300" viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg"><line opacity="0.1" stroke="#000000" stroke-width="1" x1="173" y1="239" x2="173" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="205" y1="239" x2="205" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="223" y1="239" x2="223" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="236" y1="239" x2="236" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="246" y1="239" x2="246" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="254" y1="239" x2="254" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="261" y1="239" x2="261" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="267" y1="239" x2="267" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="272" y1="239" x2="272" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="277" y1="239" x2="277" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="277" y1="239" x2="277" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="308" y1="239" x2="308" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="327" y1="239" x2="327" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="340" y1="239" x2="340" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="350" y1="239" x2="350" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="358" y1="239" x2="358" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="365" y1="239" x2="365" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="371" y1="239" x2="371" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="376" y1="239" x2="376" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="381" y1="239" x2="381" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="381" y1="239" x2="381" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="412" y1="239" x2="412" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="430" y1="239" x2="430" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="443" y1="239" x2="443" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="453" y1="239" x2="453" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="462" y1="239" x2="462" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="469" y1="239" x2="469" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="475" y1="239" x2="475" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="480" y1="239" x2="480" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="485" y1="239" x2="485" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="485" y1="239" x2="485" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="516" y1="239" x2="516" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="534" y1="239" x2="534" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="547" y1="239" x2="547" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="557" y1="239" x2="557" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="565" y1="239" x2="565" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="572" y1="239" x2="572" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="578" y1="239" x2="578" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="584" y1="239" x2="584" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="589" y1="239" x2="589" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="589" y1="239" x2="589" y2="10"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="239" x2="589" y2="239"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="228" x2="589" y2="228"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="217" x2="589" y2="217"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="205" x2="589" y2="205"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="194" x2="589" y2="194"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="182" x2="589" y2="182"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="171" x2="589" y2="171"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="159" x2="589" y2="159"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="148" x2="589" y2="148"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="136" x2="589" y2="136"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="125" x2="589" y2="125"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="114" x2="589" y2="114"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="102" x2="589" y2="102"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="91" x2="589" y2="91"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="79" x2="589" y2="79"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="68" x2="589" y2="68"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="56" x2="589" y2="56"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="45" x2="589" y2="45"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="33" x2="589" y2="33"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="22" x2="589" y2="22"/><line opacity="0.1" stroke="#000000" stroke-width="1" x1="70" y1="10" x2="589" y2="10"/><text x="10" y="125" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000" transform="rotate(270, 10, 125)">Output color</text><text x="330" y="290" dy="-0.5ex" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">Input color</text><line opacity="0.2" stroke="#000000" stroke-width="1" x1="173" y1="239" x2="173" y2="10"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="277" y1="239" x2="277" y2="10"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="381" y1="239" x2="381" y2="10"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="485" y1="239" x2="485" y2="10"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="589" y1="239" x2="589" y2="10"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="70" y1="239" x2="589" y2="239"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="70" y1="125" x2="589" y2="125"/><line opacity="0.2" stroke="#000000" stroke-width="1" x1="70" y1="10" x2="589" y2="10"/><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="69,10 69,239 "/><text x="60" y="239" dy="0.5ex" text-anchor="end" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">0.00</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="64,239 69,239 "/><text x="60" y="125" dy="0.5ex" text-anchor="end" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">0.50</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="64,125 69,125 "/><text x="60" y="10" dy="0.5ex" text-anchor="end" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">1.00</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="64,10 69,10 "/><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="70,240 589,240 "/><text x="173" y="250" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">0.001</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="173,240 173,245 "/><text x="277" y="250" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">0.01</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="277,240 277,245 "/><text x="381" y="250" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">0.1</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="381,240 381,245 "/><text x="485" y="250" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">1.0</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="485,240 485,245 "/><text x="589" y="250" dy="0.76em" text-anchor="middle" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">10.0</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="589,240 589,245 "/><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="70,239 205,239 236,239 254,238 267,238 277,237 285,237 292,236 298,236 304,235 308,235 313,234 317,234 320,234 324,233 327,233 330,232 332,232 335,231 337,231 340,230 342,230 344,229 346,229 348,229 350,228 351,228 353,227 355,227 356,226 358,226 359,225 361,225 362,224 364,224 365,223 366,223 367,223 369,222 370,222 371,221 372,221 373,220 374,220 375,219 376,219 377,218 378,218 379,218 380,217 381,217 382,216 383,216 384,215 384,215 385,214 386,214 387,213 388,213 388,212 389,212 390,212 391,211 391,211 392,210 393,210 393,209 394,209 395,208 395,208 396,207 397,207 397,207 398,206 399,206 399,205 400,205 400,204 401,204 402,203 402,203 403,202 403,202 404,201 404,201 405,201 405,200 406,200 406,199 407,199 407,198 408,198 408,197 409,197 409,196 410,196 410,196 411,195 411,195 412,194 412,194 413,193 413,193 413,192 414,192 414,191 415,191 415,190 416,190 416,190 416,189 417,189 417,188 418,188 418,187 418,187 419,186 419,186 420,185 420,185 420,185 421,184 421,184 421,183 422,183 422,182 423,182 423,181 423,181 424,180 424,180 424,180 425,179 425,179 425,178 426,178 426,177 426,177 427,176 427,176 427,175 428,175 428,174 428,174 429,174 429,173 429,173 430,172 430,172 430,171 430,171 431,170 431,170 431,169 432,169 432,169 432,168 432,168 433,167 433,167 433,166 434,166 434,165 434,165 434,164 435,164 435,163 435,163 436,163 436,162 436,162 436,161 437,161 437,160 437,160 437,159 438,159 438,158 438,158 438,158 439,157 439,157 439,156 439,156 440,155 440,155 440,154 440,154 441,153 441,153 441,152 441,152 442,152 442,151 442,151 442,150 442,150 443,149 443,149 443,148 443,148 444,147 444,147 444,147 444,146 445,146 445,145 445,145 445,144 445,144 446,143 446,143 446,142 446,142 446,141 447,141 447,141 447,140 447,140 447,139 448,139 448,138 448,138 448,137 449,137 449,136 449,136 449,136 449,135 449,135 450,134 450,134 450,133 450,133 450,132 451,132 451,131 451,131 451,130 451,130 452,130 452,129 452,129 452,128 452,128 453,127 453,127 453,126 453,126 453,125 453,125 454,125 454,124 454,124 454,123 454,123 455,122 455,122 455,121 455,121 455,120 455,120 456,120 456,119 456,119 456,118 456,118 456,117 457,117 457,116 457,116 457,115 457,115 457,114 458,114 458,114 458,113 458,113 458,112 458,112 459,111 459,111 459,110 459,110 459,109 459,109 460,109 460,108 460,108 460,107 460,107 460,106 460,106 461,105 461,105 461,104 461,104 461,103 461,103 462,103 462,102 462,102 462,101 462,101 462,100 462,100 463,99 463,99 463,98 463,98 463,98 463,97 463,97 464,96 464,96 464,95 464,95 464,94 464,94 464,93 465,93 465,92 465,92 465,92 465,91 465,91 465,90 466,90 466,89 466,89 466,88 466,88 466,87 466,87 467,87 467,86 467,86 467,85 467,85 467,84 467,84 467,83 468,83 468,82 468,82 468,81 468,81 468,81 468,80 468,80 469,79 469,79 469,78 469,78 469,77 469,77 469,76 470,76 470,76 470,75 470,75 470,74 470,74 470,73 470,73 471,72 471,72 471,71 471,71 471,70 471,70 471,70 471,69 471,69 472,68 472,68 472,67 472,67 472,66 472,66 472,65 472,65 473,65 473,64 473,64 473,63 473,63 473,62 473,62 473,61 474,61 474,60 474,60 474,60 474,59 474,59 474,58 474,58 474,57 475,57 475,56 475,56 475,55 475,55 475,54 475,54 475,54 475,53 476,53 476,52 476,52 476,51 476,51 476,50 476,50 476,49 476,49 477,49 477,48 477,48 477,47 477,47 477,46 477,46 477,45 477,45 477,44 478,44 478,43 478,43 478,43 478,42 478,42 478,41 478,41 478,40 479,40 479,39 479,39 479,38 479,38 479,38 479,37 479,37 479,36 479,36 480,35 480,35 480,34 480,34 480,33 480,33 480,32 480,32 480,32 480,31 481,31 481,30 481,30 481,29 481,29 481,28 481,28 481,27 481,27 481,27 482,26 482,26 482,25 482,25 482,24 482,24 482,23 482,23 482,22 482,22 482,21 483,21 483,21 483,20 483,20 483,19 483,19 483,18 483,18 483,17 483,17 484,16 484,16 484,16 484,15 484,15 484,14 484,14 484,13 484,13 484,12 484,12 485,11 485,11 485,10 485,10 485,10 485,10 485,10 485,10 485,10 485,10 485,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 486,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 487,10 488,10 488,10 488,10 488,10 488,10 488,10 488,10 488,10 488,10 488,10 488,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 489,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 490,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 491,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 492,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 493,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 494,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 495,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 496,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 497,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 498,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 499,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 500,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 501,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 502,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 503,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 504,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 505,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 506,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 507,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 508,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 509,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 510,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 511,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 512,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 513,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 514,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 515,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 516,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 517,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 518,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 519,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 520,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 521,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 522,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 523,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 524,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 525,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 526,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 527,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 528,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 529,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 530,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 531,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 532,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 533,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 534,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 535,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 536,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 537,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 538,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 539,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 540,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 541,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 542,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 543,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 544,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 545,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 546,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 547,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 548,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 549,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 550,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 551,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 552,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 553,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 554,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 555,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 556,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 557,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 558,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 559,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 560,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 561,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 562,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 563,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 564,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 565,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 566,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 567,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 568,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 569,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 570,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 571,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 572,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 573,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 589,10 "/><polyline fill="none" opacity="1" stroke="#FF8C00" stroke-width="2" points="70,239 205,239 236,239 254,239 267,239 277,239 285,238 292,238 298,238 304,237 308,237 313,237 317,236 320,236 324,235 327,235 330,234 332,234 335,233 337,233 340,232 342,232 344,231 346,231 348,230 350,229 351,229 353,228 355,227 356,227 358,226 359,225 361,225 362,224 364,223 365,222 366,222 367,221 369,220 370,219 371,219 372,218 373,217 374,216 375,216 376,215 377,214 378,213 379,212 380,211 381,211 382,210 383,209 384,208 384,207 385,207 386,206 387,205 388,204 388,203 389,202 390,202 391,201 391,200 392,199 393,198 393,198 394,197 395,196 395,195 396,194 397,193 397,193 398,192 399,191 399,190 400,189 400,189 401,188 402,187 402,186 403,185 403,185 404,184 404,183 405,182 405,181 406,181 406,180 407,179 407,178 408,178 408,177 409,176 409,175 410,175 410,174 411,173 411,172 412,172 412,171 413,170 413,169 413,169 414,168 414,167 415,167 415,166 416,165 416,164 416,164 417,163 417,162 418,162 418,161 418,160 419,160 419,159 420,158 420,158 420,157 421,156 421,156 421,155 422,154 422,154 423,153 423,153 423,152 424,151 424,151 424,150 425,149 425,149 425,148 426,148 426,147 426,146 427,146 427,145 427,145 428,144 428,144 428,143 429,142 429,142 429,141 430,141 430,140 430,140 430,139 431,139 431,138 431,137 432,137 432,136 432,136 432,135 433,135 433,134 433,134 434,133 434,133 434,132 434,132 435,131 435,131 435,130 436,130 436,129 436,129 436,128 437,128 437,127 437,127 437,126 438,126 438,126 438,125 438,125 439,124 439,124 439,123 439,123 440,122 440,122 440,122 440,121 441,121 441,120 441,120 441,119 442,119 442,119 442,118 442,118 442,117 443,117 443,116 443,116 443,116 444,115 444,115 444,114 444,114 445,114 445,113 445,113 445,113 445,112 446,112 446,111 446,111 446,111 446,110 447,110 447,110 447,109 447,109 447,108 448,108 448,108 448,107 448,107 449,107 449,106 449,106 449,106 449,105 449,105 450,105 450,104 450,104 450,104 450,103 451,103 451,103 451,102 451,102 451,102 452,101 452,101 452,101 452,100 452,100 453,100 453,100 453,99 453,99 453,99 453,98 454,98 454,98 454,97 454,97 454,97 455,97 455,96 455,96 455,96 455,95 455,95 456,95 456,95 456,94 456,94 456,94 456,94 457,93 457,93 457,93 457,92 457,92 457,92 458,92 458,91 458,91 458,91 458,91 458,90 459,90 459,90 459,90 459,89 459,89 459,89 460,89 460,88 460,88 460,88 460,88 460,87 460,87 461,87 461,87 461,86 461,86 461,86 461,86 462,86 462,85 462,85 462,85 462,85 462,84 462,84 463,84 463,84 463,84 463,83 463,83 463,83 463,83 464,82 464,82 464,82 464,82 464,82 464,81 464,81 465,81 465,81 465,81 465,80 465,80 465,80 465,80 466,80 466,79 466,79 466,79 466,79 466,79 466,78 467,78 467,78 467,78 467,78 467,77 467,77 467,77 467,77 468,77 468,76 468,76 468,76 468,76 468,76 468,76 468,75 469,75 469,75 469,75 469,75 469,75 469,74 469,74 470,74 470,74 470,74 470,73 470,73 470,73 470,73 470,73 471,73 471,72 471,72 471,72 471,72 471,72 471,72 471,71 471,71 472,71 472,71 472,71 472,71 472,71 472,70 472,70 472,70 473,70 473,70 473,70 473,69 473,69 473,69 473,69 473,69 474,69 474,69 474,68 474,68 474,68 474,68 474,68 474,68 474,68 475,67 475,67 475,67 475,67 475,67 475,67 475,67 475,66 475,66 476,66 476,66 476,66 476,66 476,66 476,65 476,65 476,65 476,65 477,65 477,65 477,65 477,64 477,64 477,64 477,64 477,64 477,64 477,64 478,64 478,63 478,63 478,63 478,63 478,63 478,63 478,63 478,63 479,62 479,62 479,62 479,62 479,62 479,62 479,62 479,62 479,61 479,61 480,61 480,61 480,61 480,61 480,61 480,61 480,61 480,60 480,60 480,60 481,60 481,60 481,60 481,60 481,60 481,59 481,59 481,59 481,59 481,59 482,59 482,59 482,59 482,59 482,59 482,58 482,58 482,58 482,58 482,58 482,58 483,58 483,58 483,58 483,57 483,57 483,57 483,57 483,57 483,57 483,57 484,57 484,57 484,57 484,56 484,56 484,56 484,56 484,56 484,56 484,56 484,56 485,56 485,56 485,55 485,55 485,55 485,55 485,55 485,55 485,55 485,55 485,55 486,55 486,54 486,54 486,54 486,54 486,54 486,54 486,54 486,54 486,54 486,54 486,54 487,53 487,53 487,53 487,53 487,53 487,53 487,53 487,53 487,53 487,53 487,53 487,52 488,52 488,52 488,52 488,52 488,52 488,52 488,52 488,52 488,52 488,52 488,52 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,51 489,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 490,50 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 491,49 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 492,48 493,48 493,47 493,47 493,47 493,47 493,47 493,47 493,47 493,47 493,47 493,47 493,47 493,47 494,47 494,47 494,47 494,46 494,46 494,46 494,46 494,46 494,46 494,46 494,46 494,46 494,46 494,46 495,46 495,46 495,46 495,46 495,45 495,45 495,45 495,45 495,45 495,45 495,45 495,45 495,45 495,45 496,45 496,45 496,45 496,45 496,45 496,45 496,44 496,44 496,44 496,44 496,44 496,44 496,44 496,44 497,44 497,44 497,44 497,44 497,44 497,44 497,44 497,44 497,43 497,43 497,43 497,43 497,43 497,43 497,43 498,43 498,43 498,43 498,43 498,43 498,43 498,43 498,43 498,43 498,43 498,43 498,42 498,42 498,42 498,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,42 499,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 500,41 501,41 501,41 501,41 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 501,40 502,40 502,40 502,40 502,40 502,40 502,40 502,40 502,40 502,39 502,39 502,39 502,39 502,39 502,39 502,39 502,39 502,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,39 503,38 503,38 503,38 503,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 504,38 505,38 505,38 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 505,37 506,37 506,37 506,37 506,37 506,37 506,37 506,37 506,37 506,36 506,36 506,36 506,36 506,36 506,36 506,36 506,36 506,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,36 507,35 507,35 507,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 508,35 509,35 509,35 509,35 509,35 509,35 509,35 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 509,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,34 510,33 510,33 510,33 510,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 511,33 512,33 512,33 512,33 512,33 512,33 512,33 512,33 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 512,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,32 513,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 514,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,31 515,30 515,30 515,30 515,30 515,30 515,30 515,30 515,30 515,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 516,30 517,30 517,30 517,30 517,30 517,30 517,30 517,30 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 517,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 518,29 519,29 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 519,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,28 520,27 520,27 520,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 521,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,27 522,26 522,26 522,26 522,26 522,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 523,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,26 524,25 524,25 524,25 524,25 524,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 525,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,25 526,24 526,24 526,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 527,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 528,24 529,24 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 529,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 530,23 531,23 531,23 531,23 531,23 531,23 531,23 531,23 531,23 531,23 531,23 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 531,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 532,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,22 533,21 533,21 533,21 533,21 533,21 533,21 533,21 533,21 533,21 533,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 534,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 535,21 536,21 536,21 536,21 536,21 536,21 536,21 536,21 536,21 536,21 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 536,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 537,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,20 538,19 538,19 538,19 538,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 539,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 540,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,19 541,18 541,18 541,18 541,18 541,18 541,18 541,18 541,18 541,18 541,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 542,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 543,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,18 544,17 544,17 544,17 544,17 544,17 544,17 544,17 544,17 544,17 544,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 545,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 546,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,17 547,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 548,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 549,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 550,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,16 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 551,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 552,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 553,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 554,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,15 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 555,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 556,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 557,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 558,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,14 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 559,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 560,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 561,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 562,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,13 563,12 563,12 563,12 563,12 563,12 563,12 563,12 563,12 563,12 563,12 563,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 564,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 565,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 566,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 567,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,12 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 568,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 569,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 570,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 571,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 572,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 573,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,11 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 574,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 575,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 576,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 577,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 578,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 579,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 580,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 581,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 582,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 583,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 584,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 585,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 586,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 587,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 588,10 589,10 "/><rect x="486" y="96" width="99" height="58" opacity="0.8" fill="#FFFFFF" stroke="none"/><rect x="486" y="96" width="99" height="58" opacity="1" fill="none" stroke="#000000"/><text x="526" y="106" dy="0.76em" text-anchor="start" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">Linear</text><text x="526" y="129" dy="0.76em" text-anchor="start" font-family="Source Sans Pro - Regular" font-size="14.516129032258064" opacity="1" fill="#000000">ACES</text><polyline fill="none" opacity="1" stroke="#000000" stroke-width="1" points="496,113 516,113 "/><polyline fill="none" opacity="1" stroke="#FF8C00" stroke-width="2" points="496,136 516,136 "/></svg></p>
<p>We can see in the log plot that the ACES curve boosts colors between 0.1 and
0.7, and then it starts to gracefully dim colors from 0.7 to 10.0. In contrast,
linear curve clips from 1.0 onwards.</p>
<h1>New sky dome visualizations</h1>
<article-image-pair>
    <article-caption-image>
        <img src="media/new-skylight-model/sky-elevation.apng"/>
        Elevation between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6741em;"></span><span class="mord">0..9</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6741em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∘</span></span></span></span></span></span></span></span></span></span></span>
    </article-caption-image>
    <article-caption-image>
        <img src="media/new-skylight-model/sky-turbidity.apng"/>
        Turbidity between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1..10</span></span></span></span>
    </article-caption-image>
</article-image-pair>
<p>Building on BRDF visualizations from the previous posts, we can also visualize
the sky dome under different parameter combinations.</p>
<h1>Offline rendering improvements</h1>
<video width="800" height="610" autoplay loop muted playsinline>
    <source src="media/new-skylight-model/new-offline-render-h265.mp4" type="video/mp4" />
    <source src="media/new-skylight-model/new-offline-render-vp9.webm" type="video/webm" />
</video>
<p>The offline rendering mode from the previous post gained some improvements:</p>
<ul>
<li>Parameters now support simple keyframe animations. Instead of hard-coding
animations like the swinging camera in previous posts, users can now define
keyframes for all sky model parameters. We will continue to expand the number
of animateable parameters in the future, such as object transforms and
material properties.</li>
<li>Offline renders can now have the same text annotations as the BRDF and the new
skydome visualizations.</li>
</ul>
<p>We also reviewed all our existing visualization systems and combined their
different capabilities under a single set of tools.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/9f73353bd3de949b4268f628979847b141ad7d59"><code>9f73353b</code></a></p></article-commit>
</article>
<hr><h1 id="offline-rendering-mode"><a href="#offline-rendering-mode">Offline rendering mode</a></h1>
<article>
    <article-date>2023-02-02</article-date>
    <article-content><p><info
title="Offline rendering mode"
link="offline-rendering-mode"
date="2023-02-02"
commit="17e72dada89f79bdc220726be7089aedc419dc3f"
/></p>
<video width="800" height="450" autoplay loop muted playsinline>
    <source src="media/offline-rendering-mode/title-h265.mp4" type="video/mp4" />
    <source src="media/offline-rendering-mode/title-vp9.webm" type="video/webm" />
</video>
<p>The raytracer can now run &quot;offline,&quot; which means that we never start up the
Vulkan rasterizer, and the program exits after rendering finishes. This mode can
generate offline rendered animations at high sample counts. The title animation
contains 60 frames, each rendered at 256 samples per pixel.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/17e72dada89f79bdc220726be7089aedc419dc3f"><code>17e72dad</code></a></p></article-commit>
</article>
<hr><h1 id="multithreaded-raytracer"><a href="#multithreaded-raytracer">Multithreaded raytracer</a></h1>
<article>
    <article-date>2023-02-02</article-date>
    <article-content><p><info
title="Multithreaded raytracer"
link="multithreaded-raytracer"
date="2023-02-02"
commit="d129b2601d8d95112cbd14a0f5e0a7c35a9953da"
/></p>
<video width="800" height="450" autoplay loop muted playsinline>
    <source src="media/multithreaded-raytracer/title-h265.mp4" type="video/mp4" />
    <source src="media/multithreaded-raytracer/title-vp9.webm" type="video/webm" />
</video>
<p>Raytracer is now multithreaded with <a href="https://crates.io/crates/rayon"><code>rayon</code></a>. We split the image into
16x16 pixel tiles and use <code>into_par_iter()</code> to render tiles in parallel. On AMD
Ryzen 5950X processor, we can render the cube scene at 66 MRays/s, up from 4.6
MRays/s we had previously with our single-threaded raytracer. If we only used
one sample per pixel, it would run slightly over 60 fps. Of course, the image
would be very noisy, but at least it would be interactive.</p>
<p>To retain our previous single-threaded debugging capabilities, we can set
<code>RAYON_NUM_THREADS=1</code> to force <code>rayon</code> only to use one thread.</p>
<p>With multithreading, there is a subtle issue with our current random number
generator because we can no longer share the same RNG across all threads without
locking. We can sidestep the whole problem because we can initialize the RNG
with a unique seed at each pixel, like so:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">see</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">ima</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>Multiplying by <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">am</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ensures the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">see</span><span class="mord mathnormal">d</span></span></span></span> is different at each sample.
With this strategy, we assume that the cost of creating an RNG is negligible
compared to the rest of the raytracer, which is true with <code>rand_pcg</code>.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/d129b2601d8d95112cbd14a0f5e0a7c35a9953da"><code>d129b260</code></a></p></article-commit>
</article>
<hr><h1 id="a-new-shiny-specular-brdf"><a href="#a-new-shiny-specular-brdf">A new shiny specular BRDF</a></h1>
<article>
    <article-date>2023-01-31</article-date>
    <article-content><p><info
title="A new shiny specular BRDF"
link="a-new-shiny-specular-brdf"
date="2023-01-31"
commit="bf578f68f0c0906a9cb50548eb3e830cd69222d6"
/></p>
<p><img src="media/a-new-shiny-specular-brdf/title.png" alt="" /></p>
<h1>A very brief overview of microfacet models</h1>
<p>A popular way to model physically based reflective surfaces is to imagine that
such surfaces are built of small perfect mirrors called microfacets.
Conceptually, each facet has a random height and orientation. The randomness of
these properties determines the roughness of the microsurface. These microfacets
are so tiny that they can be modeled with functions, as opposed to being modeled
with geometry or with normal maps, for example.</p>
<p>Let's define some common terms first:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.75em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">incoming direction</span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">outgoing direction</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">microsurface normal</span></span></span></span><span style="top:-0.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">geometric normal</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>The popular <a href="https://inst.eecs.berkeley.edu//~cs283/sp13/lectures/cookpaper.pdf">Cook-Torrance model</a> is defined as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3991em;vertical-align:-0.9721em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> is the <em>normal distribution function</em>, or NDF. It describes how
microfacet varies related to the microsurface normal <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>. Disney model
uses the widely popular <a href="https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf">GGX distribution</a>, so that is what we are
going to use as well.</p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> describes how much light is reflected from a microfacet.
We use the same Schlick's approximation as we did with Disney diffuse BRDF.</p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> is the masking-shadowing function. It
describes the ratio of masked or shadowed microfacets when viewed from a pair of
incoming and outgoing directions. We implemented Smith's height-correlated
masking-shadowing function from this great paper by Eric Heitz called
<a href="https://jcgt.org/published/0003/02/03/paper.pdf">Understanding the Masking-Shadowing Function in Microfacet-Based
BRDFs</a>.</p>
<h1>Microfacet models in practice</h1>
<article-image>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/bug.png"></img>
        What happens if we use a wrong coordinate system
    </article-caption-image>
</article-image>
<p>Translating math into source code has a couple of gotchas we need to be aware
of:</p>
<ul>
<li>Different papers have different naming conventions (incoming vs. light,
outgoing vs. view), and different coordinate systems (z is up vs. y is up),
which can quickly get confusing if we are not being consistent.</li>
<li>Floating point inaccuracies can make various terms go to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span> or become a
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord text"><span class="mord">Not a Number</span></span></span></span></span>. For example, if the incident or outgoing rays are close
to being perpendicular to the surface normal, the cosine of their angles
related to the surface normal approaches zero. Then, any expression divided by
this value results in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">∞</span></span></span></span>. The program won't crash, but the image will
slowly become more and more corrupted with black or white pixels. We must take
extra care to clamp such values to a small positive number to avoid dividing
by zero.</li>
<li>Sometimes the sampled vector appears below the hemisphere. In these cases, we
discard the whole sample because those samples have zero reflectance.</li>
</ul>
<p>We also use the trick from <code>pbrt</code> where they perform all BRDF calculations in a
local space, where the surface normal <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>. In this local space,
many computations simplify a lot. For example, computing the dot product between
a vector against the surface normal is simply the y-component of the vector. We
can use the same orthonormal basis from the previous posts to go from world to
local space, and once we are done with all BRDF math, we can transform the
results back to world space.</p>
<h1>Integrating microfacets with Disney diffuse BRDF</h1>
<p><img src="media/a-new-shiny-specular-brdf/metallic-lerp.apng" alt="" /></p>
<p>The new specular BRDF introduced three new parameters to our material:</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span> is a linear blend between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span>. The
&quot;specular color&quot; is derived from the base color.</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> replaces the explicit index of refraction. It is currently fixed to
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span></span></span></span> because we don't have a way to get it from GLB yet.</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ani</span><span class="mord mathnormal">so</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span> defines the degree of anisotropy. Controls the aspect ratio of
the specular highlight. It's currently disabled because our model does not
have tangents.</li>
</ul>
<p>The Disney paper states that their model allows their artists to blend between
any two combinations of parameters and have good results. In the example we
interpolate metallic from <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span></span></span></span> to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>.</p>
<p>We now have an interesting problem: choosing which BRDF to sample from. The
Disney paper doesn't describe a method for it, so in our implementation, we draw
a new random variable that selects between diffuse and specular BRDF based on
the metallic parameter. For example, if the metallic value is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.5</span></span></span></span>, both
diffuse and specular BRDFs are equally likely to be chosen.</p>
<h1>Animated BRDF visualizations</h1>
<article-image-pair>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/microfacet-reflection-r-scalar-sobol-hemisphere.png"/>
    </article-caption-image>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/microfacet-reflection-r-incoming-sobol-hemisphere.png"/>
    </article-caption-image>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/microfacet-reflection-r-scalar-sobol-angle.png"/>
        Fixed incoming direction<br/>
        Roughness interpolates between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>
    </article-caption-image>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/microfacet-reflection-r-incoming-sobol-angle.png"/>
        Incoming direction interpolates along x-axis<br/>
        Fixed roughness to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.25</span></span></span></span>
    </article-caption-image>
</article-image-pair>
<p>We dramatically improved the capabilities of the sample placement visualizer
from the previous post. The visualizations are now animated and can render
different text for each frame, and reflectance is directly visualized separately
from probability density functions.</p>
<p>The animations are encoded in <a href="https://en.wikipedia.org/wiki/APNG">APNG</a> format. We chose APNG because:</p>
<ul>
<li>GIF is too low quality due to limited 256-color palette limitation</li>
<li>WebP's crate takes very long to build and has slightly worse support than APNG</li>
<li>Traditional video formats are not as convenient for short looping animations</li>
</ul>
<p>We used these crates to create the animations:</p>
<ul>
<li><a href="https://crates.io/crates/apng"><code>apng</code></a> for encoding APNG's from <a href="https://crates.io/crates/image"><code>image</code></a> buffers.</li>
<li><a href="https://crates.io/crates/png"><code>png</code></a> so we can properly call into <a href="https://crates.io/crates/apng"><code>apng</code></a>.</li>
<li><a href="https://crates.io/crates/easer"><code>easer</code></a> for <a href="https://easings.net/">easing functions</a> We use <code>easeInOutCubic</code> for interesting movement.</li>
<li><a href="https://crates.io/crates/imageproc"><code>imageproc</code></a> for drawing text on <a href="https://crates.io/crates/image"><code>image</code></a> buffers.</li>
<li><a href="https://crates.io/crates/rusttype"><code>rusttype</code></a> for loading TTF fonts for <a href="https://crates.io/crates/imageproc"><code>imageproc</code></a>.</li>
<li><a href="https://crates.io/crates/rayon"><code>rayon</code></a> for simple data-parallelism to speed up animation renders.</li>
</ul>
<h1>A simple interactive material editor</h1>
<video width="800" height="450" autoplay loop muted playsinline>
    <source src="media/a-new-shiny-specular-brdf/material-editor-h265.mp4" type="video/mp4" />
    <source src="media/a-new-shiny-specular-brdf/material-editor-vp9.webm" type="video/webm" />
</video>
<p>Having to recompile the program or exporting a new scene from Blender every time
we needed to change the roughness or metallic value quickly became a significant
bottleneck. Since our raytracing is already progressive, we can quickly
implement simple material edits and have the raytracer re-render the image at
each change.</p>
<p>We will rewrite this utility after a more extensive user interface overhaul.</p>
<h1>Visualizing normals</h1>
<article-image-pair>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/normal-raytraced.png" width="100%"/>
        Raytraced
    </article-caption-image>
    <article-caption-image>
        <img src="media/a-new-shiny-specular-brdf/normal-rasterized.png" width="100%"/>
        Rasterized
    </article-caption-image>
</article-image-pair>
<p>While hunting for bugs in our specular BRDFs, we added a simple way to visualize
shading normals in raytraced and rasterized scenes. We will add visualizations
for texture coordinates and tangents in the future.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/bf578f68f0c0906a9cb50548eb3e830cd69222d6"><code>bf578f68</code></a></p></article-commit>
</article>
<hr><h1 id="visualizing-sample-placement"><a href="#visualizing-sample-placement">Visualizing sample placement</a></h1>
<article>
    <article-date>2023-01-19</article-date>
    <article-content><p><info
title="Visualizing sample placement"
link="visualizing-sample-placement"
date="2023-01-19"
commit="f5b806749234a4086d84388d7264c0f2fd43122a"
/></p>
<p><img src="media/visualizing-sample-placement/title-top.png" alt="" />
<img src="media/visualizing-sample-placement/title-side.png" alt="" /></p>
<p>Importance sampling Disney specular models is more challenging than our current
diffuse models. To improve our chances, we created a small tool that visualizes
where the samples are placed around the hemisphere.</p>
<p>We used our existing uniform and cosine-weighted hemisphere samplers to ensure
the tool worked. We also added two additional sample sequences for comparison:</p>
<ol>
<li><code>grid</code> sequence, which uniformly samples the unit square.</li>
<li><code>sobol</code> sequence, which is provided by the
<a href="https://crates.io/crates/sobol_burley"><code>sobol_burley</code></a> crate. The implementation is based on
<a href="https://www.jcgt.org/published/0009/04/01/">Practical Hash-based Owen Scrambling</a>.</li>
</ol>
<p>In terms of coordinate spaces, the <code>top</code> plots view the hemisphere from above in
cartesian space. The <code>side</code> plots in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ϕ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mclose">]</span></span></span></span> and
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">]</span></span></span></span> hemispherical space.</p>
<p>For both sets of plots, the background brightness corresponds to the magnitude
of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>.</p>
<p>Looking at the plots, we can intuitively say that <code>cosine</code> performs better than
<code>uniform</code> sampling because it places samples closer to the bright spots.
Similarly, <code>sobol</code> performs better than <code>random</code> and <code>grid</code>.</p>
<p>Note that the new sequences are not currently available for rendering. We will
revisit low-discrepancy sequences later.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/f5b806749234a4086d84388d7264c0f2fd43122a"><code>f5b80674</code></a></p></article-commit>
</article>
<hr><h1 id="implementing-disney-brdf-diffuse-model"><a href="#implementing-disney-brdf-diffuse-model">Implementing Disney BRDF - Diffuse model</a></h1>
<article>
    <article-date>2023-01-19</article-date>
    <article-content><p><info
title="Implementing Disney BRDF - Diffuse model"
link="implementing-disney-brdf-diffuse-model"
date="2023-01-19"
commit="c43f282e24a6eecb54fa3361a6e5e192453d0d8d"
/></p>
<p><img src="media/implementing-disney-brdf-diffuse-model/title.apng" alt="" /></p>
<p><a href="https://blog.selfshadow.com/publications/s2012-shading-course/burley/s2012_pbs_disney_brdf_notes_v3.pdf">Disney principled BRDF</a> is a popular physically based reflectance
model developed by Brent Burley et al. at Disney. It is adopted by
<a href="https://docs.blender.org/manual/en/latest/render/shader_nodes/shader/principled.html">Blender</a>, <a href="https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf">Unreal Engine</a>, <a href="https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf">Frostbite</a>, and many
other productions. The team at Disney analyzed the <a href="https://www.merl.com/brdf/">MERL BRDF Database</a>
and fit their model based on MERL's empirical measurements. Their goal was to
create an artist-friendly model with as few parameters as possible. These are
the design principles from the course notes:</p>
<ol>
<li>Intuitive rather than physical parameters should be used.</li>
<li>There should be as few parameters as possible.</li>
<li>Parameters should be zero to one over their plausible range.</li>
<li>Parameters should be allowed to be pushed beyond their plausible range where it makes sense.</li>
<li>All combinations of parameters should be as robust and plausible as possible.</li>
</ol>
<p>The full Disney model combines multiple scattering models, some of which we need
to become more experienced with. To avoid getting overwhelmed, we will study and
implement one model at a time, starting with the diffuse model <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, which is
defined as:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:17.4298em;vertical-align:-8.4649em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.9649em;"><span style="top:-10.9649em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-9.1148em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-7.5907em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">o</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="mord mtight">90</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.5666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-1.5666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:1.4334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:2.9334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:4.4334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:8.4649em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.9649em;"><span style="top:-10.9649em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">ba</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">o</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-9.1148em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="mord mtight">90</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span><span style="top:-7.5907em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span><span class="mord mtight">90</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span><span style="top:-6.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">2</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.03588em;">ug</span><span class="mord mathnormal">hn</span><span class="mord mathnormal">ess</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">cos</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.5666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-1.5666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-0.0666em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">incoming direction</span></span></span></span><span style="top:1.4334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">outgoing direction</span></span></span></span><span style="top:2.9334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">microsurface normal</span></span></span></span><span style="top:4.4334em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">geometric normal</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:8.4649em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>Disney's diffuse model is a novel empirical model which attempts to solve the
over-darkening that comes from the Lambertian diffuse model. This darkening
happens at grazing angles, i.e., the angle between the incoming and outgoing
light is close to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>. Disney models this by adding a <a href="https://en.wikipedia.org/wiki/Fresnel_equations">Fresnel
factor</a>, which they approximated with <a href="https://en.wikipedia.org/wiki/Schlick%27s_approximation">Schlick's
approximation</a>.</p>
<p>The difference in the comparison above can be subtle. The main difference is
that the cube's edges are slightly brighter compared to the Lambert model, and
the right side of the cube also appears brighter.</p>
<p>Our implementation ignores the &quot;sheen&quot; term and the subsurface scattering
approximation. We will come back to these terms later. Also, any roughness value
below <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> looks incorrect because our current implementation has no specular
terms.</p>
<p>References:</p>
<ul>
<li><a href="https://blog.selfshadow.com/publications/s2012-shading-course/burley/s2012_pbs_disney_brdf_notes_v3.pdf">SIGGRAPH 2012 - Physically Based Shading at Disney - Course Notes</a></li>
<li><a href="https://schuttejoe.github.io/post/disneybsdf/">Joe Schutte - Rendering the Moana Island Scene Part 1: Implementing the Disney BSDF</a></li>
<li><a href="http://shihchinw.github.io/2015/07/implementing-disney-principled-brdf-in-arnold.html">Shih-Chin - Implementing Disney Principled BRDF in Arnold</a></li>
<li><a href="https://github.com/mmp/pbrt-v3/blob/master/src/materials/disney.cpp"><code>pbrt-v3 - disney.cpp</code></a></li>
<li><a href="https://github.com/wdas/brdf">Disney BRDF Explorer</a></li>
</ul></article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/c43f282e24a6eecb54fa3361a6e5e192453d0d8d"><code>c43f282e</code></a></p></article-commit>
</article>
<hr><h1 id="texture-support"><a href="#texture-support">Texture support</a></h1>
<article>
    <article-date>2023-01-15</article-date>
    <article-content><p><info
title="Texture support"
link="texture-support"
date="2023-01-15"
commit="41a05a78d6fbba82436faece9815c4e8b3da9951"
/></p>
<p><img src="media/texture-support/title.apng" alt="" /></p>
<p>Raydiance now supports texture-mapped surfaces. We used multiple shortcuts to
get a basic implementation going:</p>
<ul>
<li>Only nearest-neighbor filtering is supported.</li>
<li>No mipmaps.</li>
<li>No anisotropic filtering.</li>
<li>Only the <code>R8G8B8A8_UNORM</code> pixel format is supported.</li>
</ul>
<p>We will revisit these shortcuts later once our scenes get more complicated.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/41a05a78d6fbba82436faece9815c4e8b3da9951"><code>41a05a78</code></a></p></article-commit>
</article>
<hr><h1 id="new-user-interface"><a href="#new-user-interface">New user interface</a></h1>
<article>
    <article-date>2023-01-15</article-date>
    <article-content><p><info
title="New user interface"
link="new-user-interface"
date="2023-01-15"
commit="9fb5a3800a337b5d663e1c83932e03fe96abfe0f"
/></p>
<p><img src="media/new-user-interface/title.apng" alt="" /></p>
<p>It was time to replace the window title hacks and random keybindings with a real
graphical user interface. We use the the excellent <a href="https://github.com/ocornut/imgui">Dear ImGui</a>
library. Since our project is written in Rust, we use <a href="https://crates.io/crates/imgui"><code>imgui</code></a> and
<a href="https://crates.io/crates/imgui-winit-support"><code>imgui-winit-support</code></a> crates to wrap the original
C++ library and interface with <a href="https://crates.io/crates/winit"><code>winit</code></a>.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/9fb5a3800a337b5d663e1c83932e03fe96abfe0f"><code>9fb5a380</code></a></p></article-commit>
</article>
<hr><h1 id="cosine-weighted-hemisphere-sampling"><a href="#cosine-weighted-hemisphere-sampling">Cosine-weighted hemisphere sampling</a></h1>
<article>
    <article-date>2023-01-13</article-date>
    <article-content><p><info
title="Cosine-weighted hemisphere sampling"
link="cosine-weighted-hemisphere-sampling"
date="2023-01-13"
commit="2e0e31997c20714ccc6a3735cf3a5c0a899f9ab9"
/></p>
<p><img src="media/cosine-weighted-hemisphere-sampling/title.apng" alt="" /></p>
<p>To get a clearer picture, we could increase the number of samples, which would
increase render times, forcing us to find ways to make the renderer run faster.
Alternatively, we could be smarter at using our limited number of samples. This
way of reducing noise in Monte Carlo simulations is called <a href="https://en.wikipedia.org/wiki/Importance_sampling">importance
sampling</a>. One of the most impactful techniques for
our simple diffuse cube scene is cosine-weighted hemisphere sampling. Since the
rendering equation has a cosine term, it makes sense to sample from a similar
distribution. We based our implementation on <a href="https://www.pbr-book.org/3ed-2018/Monte_Carlo_Integration/2D_Sampling_with_Multidimensional_Transformations#Cosine-WeightedHemisphereSampling"><code>pbrt</code></a>.</p>
<article-image-pair>
    <article-caption-image>
        <img src="media/cosine-weighted-hemisphere-sampling/uniform.apng"/>
        Uniform sampling
    </article-caption-image>
    <article-caption-image>
        <img src="media/cosine-weighted-hemisphere-sampling/cosine.apng"/>
        Cosine-weighted sampling
    </article-caption-image>
</article-image-pair>
<p>Here is the comparison between uniform sampling. It is clear that with identical
sample counts, cosine-weighted sampling results in a much clearer picture than
uniform sampling. And it does it at an equivalent time.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/2e0e31997c20714ccc6a3735cf3a5c0a899f9ab9"><code>2e0e3199</code></a></p></article-commit>
</article>
<hr><h1 id="progressive-rendering"><a href="#progressive-rendering">Progressive rendering</a></h1>
<article>
    <article-date>2023-01-12</article-date>
    <article-content><p><info
title="Progressive rendering"
link="progressive-rendering"
date="2023-01-12"
commit="f50c3b6f92eedd52e43406ee4960d3b50b5025ac"
/></p>
<p><img src="media/progressive-rendering/title.apng" alt="" /></p>
<p>Previously we had to wait until the renderer completed the entire image before
displaying it on the screen. In this commit, we redesigned the path tracing loop
to render progressively and submit intermediate frames as soon as they are
finished. This change significantly improves interactivity.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/f50c3b6f92eedd52e43406ee4960d3b50b5025ac"><code>f50c3b6f</code></a></p></article-commit>
</article>
<hr><h1 id="interactive-cpu-path-tracer"><a href="#interactive-cpu-path-tracer">Interactive CPU path tracer</a></h1>
<article>
    <article-date>2023-01-12</article-date>
    <article-content><p><info
title="Interactive CPU path tracer"
link="interactive-cpu-path-tracer"
date="2023-01-12"
commit="956e4bf6a4fdb2db5ea790acac1227c0297e58ac"
/></p>
<p><img src="media/interactive-cpu-path-tracer/title.apng" alt="" /></p>
<p>This commit merges the CPU path tracer with the Vulkan renderer and makes the
camera interactive. As soon as the path tracer finishes rendering, the image is
uploaded to the GPU and rendered on the window. We can also toggle between
raytraced and rasterized images to confirm that both renderers are in sync.</p>
<p>To keep the Vulkan renderer running while the CPU is busy path tracing, we need
to run the path tracer on a separate thread. To communicate across thread
boundaries, we use Rust standard library <a href="https://doc.rust-lang.org/std/sync/mpsc/index.html"><code>std::sync::mpsc:channel</code></a>.
The main thread sends camera transforms to the path tracer, and the path tracer
sends the rendered images back to the main thread. The path tracer thread blocks
the channel to prevent busy looping.</p>
<p>For displaying path traced images on the window, we set up both the uploader and
the rendering pipeline for the image.</p>
<p>We used two tricks to render the image:</p>
<ul>
<li>To render a fullscreen textured quad, you don't need to create vertex buffers,
set up vertex inputs, etc. With this <a href="https://www.saschawillems.de/blog/2016/08/13/vulkan-tutorial-on-rendering-a-fullscreen-quad-without-buffers/">trick</a>, you can use
<code>gl_VertexIndex</code> intrinsic in the vertex shader to build a huge triangle and
then calculate its UVs. This technique saves a lot of boilerplate code.</li>
<li>In Vulkan, if you want to sample a texture in your fragment shader, you need
to create descriptor pools, and descriptor set layouts, allocate descriptor
sets, make sure pipeline layouts are correct, bind the descriptor sets, and so
on. With <a href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#VK_KHR_push_descriptor"><code>VK_KHR_push_descriptor</code></a> extension, it is possible
to simplify this process significantly. Enabling it allows you to push the
descriptor right before issuing the draw call, saving a lot of boilerplate. We
still have to create one descriptor set layout for the pipeline layout object,
but that is pretty good compared to what we had to do before, only to bind one
texture to a shader.</li>
</ul>
<p>As a side, <code>vulkan.rs</code> is reaching 2000 LOC, which is getting challenging to
work with. We will have to break it down soon.</p>
<p>The path tracing performance could be better because we are still using only one
thread. It is also why the image is noisier than the previous post since we had
to lower the sample count to get barely interactive frame rates. We will address
the noise and the performance in upcoming commits.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/956e4bf6a4fdb2db5ea790acac1227c0297e58ac"><code>956e4bf6</code></a></p></article-commit>
</article>
<hr><h1 id="path-tracing-on-cpu"><a href="#path-tracing-on-cpu">Path tracing on CPU</a></h1>
<article>
    <article-date>2023-01-11</article-date>
    <article-content><p><info
title="Path tracing on CPU"
link="path-tracing-on-cpu"
date="2023-01-11"
commit="4ade2d5b2acc3da8fabb5d275b9152171ed01ea9"
/></p>
<p><img src="media/path-tracing-on-cpu/title.png" alt="" /></p>
<p>Finally, we are getting into the main feature of <code>raydiance</code>: rendering pretty
images using path tracing. We start with a pure CPU implementation. The plan is
to develop and maintain the CPU version as the reference implementation for the
future GPU version, mainly because it is much easier to work with, especially
when debugging shaders. The Vulkan renderer we've built so far serves as the
visual interface for <code>raydiance</code>, and later, we will use Vulkan's ray tracing
extensions to create the GPU version.</p>
<p>We use the following components:</p>
<ul>
<li>Ray vs triangle intersection: <a href="https://jcgt.org/published/0002/01/05/">Watertight Ray/Triangle Intersection</a></li>
<li>Orthonormal basis: <a href="https://jcgt.org/published/0006/01/01/">Building an Orthonormal Basis, Revisited</a></li>
<li>Uniformly distributed random numbers: <a href="https://crates.io/crates/rand"><code>rand</code></a> and <a href="https://crates.io/crates/rand_pcg"><code>rand_pcg</code></a> crates</li>
<li>Uniform hemisphere sampling: <a href="https://www.pbr-book.org/3ed-2018/Monte_Carlo_Integration/2D_Sampling_with_Multidimensional_Transformations#UniformlySamplingaHemisphere"><code>pbrt</code></a></li>
<li>Acceleration structure (bounding volume hierarchy): <a href="https://www.pbr-book.org/3ed-2018/Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies"><code>pbrt</code></a></li>
</ul>
<p>We put this together into a loop, where we bounce rays until they hit the sky or
have bounced too many times. Each pixel in the image does this several times,
averages all the samples, and writes out the final color to the image buffer.</p>
<p>For materials, we start with the simplest one: Lambertian material, which
scatters incoming light equally in all directions. However, a subtle detail in
Lambertian BRDF is that you have to divide the base color with <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span>. Here's the
explanation from <a href="https://www.pbr-book.org/3ed-2018/Reflection_Models/Lambertian_Reflection"><code>pbrt</code></a>.</p>
<p>For lights, we assume that every ray that bounces off the scene will hit “the
sky.” In that case, we return a bright white color.</p>
<p>For anti-aliasing, we randomly shift the subpixel position of each primary ray
and apply the box filter over the samples. With enough samples, this naturally
resolves into a nice image with no aliasing. <a href="https://www.pbr-book.org/3ed-2018/Sampling_and_Reconstruction/Image_Reconstruction"><code>pbrt</code></a>'s image
reconstruction chapter has better alternatives for the box filter, which we
might look into later.</p>
<p>We currently run the path tracer in a single CPU thread. This could be better,
but the rendering only takes a couple of seconds for such a tiny image and a low
sample count. We will return to this once we need to make the path tracer run at
interactive speeds.</p>
<p>Currently, raydiance doesn't display the path traced image anywhere. For this
post, we wrote the image out directly into the disk. We will fix this soon.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/4ade2d5b2acc3da8fabb5d275b9152171ed01ea9"><code>4ade2d5b</code></a></p></article-commit>
</article>
<hr><h1 id="adding-multisampled-antialiasing-msaa"><a href="#adding-multisampled-antialiasing-msaa">Adding multisampled anti-aliasing (MSAA)</a></h1>
<article>
    <article-date>2023-01-09</article-date>
    <article-content><p><info
title="Adding multisampled anti-aliasing (MSAA)"
link="adding-multisampled-antialiasing-msaa"
date="2023-01-09"
commit="ca2a23caaa5e9d9b321a50389af492fbc708b560"
/></p>
<p><img src="media/adding-multisampled-antialiasing-msaa/title.png" alt="" /></p>
<p>Implementing MSAA was easy. Similarly to the depth buffer, we create a new color
buffer which will be multisampled. The depth buffer is also updated to support
multisampling. Then we update all the <code>resolve*</code> fields in
<a href="https://registry.khronos.org/vulkan/specs/1.3-extensions/man/html/VkRenderingAttachmentInfo.html"><code>VkRenderingAttachmentInfo</code></a>, and finally, we add the multisampling
state to our pipeline. No more jagged edges.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/ca2a23caaa5e9d9b321a50389af492fbc708b560"><code>ca2a23ca</code></a></p></article-commit>
</article>
<hr><h1 id="more-triangles-cameras-light-and-depth"><a href="#more-triangles-cameras-light-and-depth">More triangles, cameras, light, and depth</a></h1>
<article>
    <article-date>2023-01-09</article-date>
    <article-content><p><info
title="More triangles, cameras, light, and depth"
link="more-triangles-cameras-light-and-depth"
date="2023-01-09"
commit="cb1bcc1975e3860b7208cffb4286fec3e91cc5d2"
/></p>
<p><img src="media/more-triangles-cameras-light-and-depth/title.apng" alt="spinning cube" /></p>
<p>A lot has happened since our single hardcoded triangle. We can now render
shaded, depth tested, transformed, and indexed triangle lists with perspective
projection.</p>
<h1>Loading and rendering GLTF scenes</h1>
<p><img src="media/more-triangles-cameras-light-and-depth/blender-view.png" alt="" /></p>
<p>We created a simple &quot;cube on a plane&quot; scene in Blender. Each object has a
&quot;Principled BSDF&quot; material attached to it. This material is well supported by
<a href="https://docs.blender.org/manual/en/latest/addons/import_export/scene_gltf2.html#extensions">Blender's GLTF exporter</a>, which is what we will use for our
application. GLTF supports text formats, but we will export the scene in binary
(<code>.glb</code>) for efficiency.</p>
<p>To load the <code>.glb</code> file, we use <a href="https://crates.io/crates/gltf"><code>gltf</code></a> crate. Immediately after
loading, we pick out the interesting fields (cameras, meshes, materials) and
convert them into our <a href="https://github.com/phoekz/raydiance/blob/cb1bcc1975e3860b7208cffb4286fec3e91cc5d2/src/assets.rs#L3-L35">internal data format</a>. We designed this
internal format to be easy to upload to the GPU. We also do aggressive
validation to catch any properties that we don't support yet, such as textures,
meshes that do not have normals, etc. Our internal formats represent matrices
and vectors with types from <a href="https://crates.io/crates/nalgebra"><code>nalgebra</code></a> crate. To turn our
internal formats into byte slices, we use the <a href="https://crates.io/crates/bytemuck"><code>bytemuck</code></a>
crate.</p>
<p>Before we can render, we need to upload geometry data to the GPU. We assume the
number of meshes is much less than 4096 (on most Windows hosts, the
<a href="https://vulkan.gpuinfo.org/displaydevicelimit.php?platform=windows&amp;name=maxMemoryAllocationCount"><code>maxMemoryAllocationCount</code></a> is 4096). This assumption allows us to
cheat and allocate buffers for each mesh. The better way to handle allocations
is to make a few large allocations and sub-allocate within those, which we can
do ourselves or use a library like <a href="https://github.com/GPUOpen-LibrariesAndSDKs/VulkanMemoryAllocator"><code>VulkanMemoryAllocator</code></a>. We will come
back to memory allocators in the future.</p>
<p>To render, we will have to work out the perspective projection, the view
transform, and object transforms from GLTF. We also add a rotation transform to
animate the cube. We pre-multiply all transforms and upload the final matrix to
the vertex shader using <a href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#descriptorsets-push-constants">push constants</a>. We also pack the base
color into the push constant. Push constants are great for small data because we
can avoid the following:</p>
<ol>
<li>Descriptor set layouts, descriptor pools, descriptor sets</li>
<li>Uniform buffers, which would have to be double buffered to avoid pipeline stalls</li>
<li>Synchronizing updates to uniform buffers</li>
</ol>
<p>As a side, while looking into push constants, we learned about
<a href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#VK_KHR_push_descriptor"><code>VK_KHR_push_descriptor</code></a>. This extension could simplify
working with Vulkan, which is exciting. We will return to it once we get into
texture mapping.</p>
<h1>Depth testing with <code>VK_KHR_dynamic_rendering</code></h1>
<p><img src="media/more-triangles-cameras-light-and-depth/depth-attachment.png" alt="" /></p>
<p>Depth testing requires a depth texture, which we create at startup, and
re-create when the window changes size. To enable depth testing with
<code>VK_KHR_dynamic_rendering</code>, we had to extend our graphics pipeline with a new
structure called <a href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/vkspec.html#VkPipelineRenderingCreateInfo"><code>VkPipelineRenderingCreateInfo</code></a> and add a
color blend state which was previously left out. One additional pipeline barrier
was required to transition the depth texture for rendering.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/cb1bcc1975e3860b7208cffb4286fec3e91cc5d2"><code>cb1bcc19</code></a></p></article-commit>
</article>
<hr><h1 id="first-triangle"><a href="#first-triangle">The first triangle</a></h1>
<article>
    <article-date>2023-01-08</article-date>
    <article-content><p><info
title="The first triangle"
link="first-triangle"
date="2023-01-08"
commit="c8f9ef2c0f3b51ddfd71f33ec086fca1531051ab"
/></p>
<p><img src="media/first-triangle/title.apng" alt="first triangle" /></p>
<p>This is the simplest triangle example rendered without any device memory
allocations. The triangle is hardcoded in the vertex shader, and we index into
its attributes with vertex index.</p>
<p>We added a simple shader compiling step in <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html"><code>build.rs</code></a> which builds
<code>.glsl</code> source code into <code>.spv</code> binary format using Google's <a href="https://github.com/google/shaderc/tree/main/glslc"><code>glslc</code></a>,
which is included in <a href="https://vulkan.lunarg.com/sdk/home">LunarG's Vulkan SDK</a>.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/c8f9ef2c0f3b51ddfd71f33ec086fca1531051ab"><code>c8f9ef2c</code></a></p></article-commit>
</article>
<hr><h1 id="clearing-window"><a href="#clearing-window">Clearing window with <code>VK_KHR_dynamic_rendering</code></a></h1>
<article>
    <article-date>2023-01-08</article-date>
    <article-content><p><info
title="Clearing window with <code>VK_KHR_dynamic_rendering</code>"
link="clearing-window"
date="2023-01-08"
commit="0f6d7f1bf1b22d1fff43e87080c854eadb3e459d"
/></p>
<p><img src="media/clearing-window/title.apng" alt="resizable color window" /></p>
<p>After around 1000 LOC, we have a barebones Vulkan application which:</p>
<ol>
<li>Load Vulkan with <a href="https://crates.io/crates/ash"><code>ash</code></a> crate.</li>
<li>Creates Vulkan instance with <code>VK_LAYER_KHRONOS_validation</code> and debug
utilities.</li>
<li>Creates window surface with <a href="https://crates.io/crates/ash-window"><code>ash-window</code></a> and
<a href="https://crates.io/crates/raw-window-handle"><code>raw-window-handle</code></a> crates.</li>
<li>Creates a logical device and queues.</li>
<li>Creates command pool and buffers.</li>
<li>Creates the swapchain.</li>
<li>Creates semaphores and fences for host-to-host and host-to-device
synchronization.</li>
<li>Clears the screen with a different color for every frame.</li>
</ol>
<p>We also handle tricky situations, such as the user resizing the window and
minimizing the window.</p>
<p>We don't have to create render passes or framebuffers, thanks to the
<code>VK_KHR_dynamic_rendering</code> extension. However, we have to specify some render
pass parameters when we record command buffers, but reducing the number of API
abstractions simplifies the implementation. We used this
<a href="https://github.com/SaschaWillems/Vulkan/blob/313ac10de4a765997ddf5202c599e4a0ca32c8ca/examples/dynamicrendering/dynamicrendering.cpp">example</a> by Sascha Willems as a reference.</p>
<p>We wrote everything under the <code>main()</code> with minimal abstractions and liberal use
of the <code>unsafe</code> keyword. We will do a <a href="https://caseymuratori.com/blog_0015">semantic compression</a> pass later
once we learn more about how to structure the program.</p>
<p>Next we will continue with more Vulkan code to get a triangle on the screen.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/0f6d7f1bf1b22d1fff43e87080c854eadb3e459d"><code>0f6d7f1b</code></a></p></article-commit>
</article>
<hr><h1 id="hello-winit"><a href="#hello-winit">Hello, <code>winit</code>!</a></h1>
<article>
    <article-date>2023-01-07</article-date>
    <article-content><p><info
title="Hello, <code>winit</code>!"
link="hello-winit"
date="2023-01-07"
commit="ff4c31c2c6c2039d33bfd07865448da963febfd6"
/></p>
<p><img src="media/hello-winit/title.png" alt="empty window" /></p>
<p>Before anything interesting can happen, we need a window to draw on. We use the
<a href="https://crates.io/crates/winit"><code>winit</code></a> crate for windowing and handling inputs. For convenience,
we bound the Escape key to close the window and center the window in the middle
of the primary monitor.</p>
<p>For simple logging, we use <a href="https://crates.io/crates/log"><code>log</code></a> and
<a href="https://crates.io/crates/env_logger"><code>env_logger</code></a>, and for application-level error handling, we
use <a href="https://crates.io/crates/anyhow"><code>anyhow</code></a>.</p>
<p>Next, we will slog through a huge Vulkan boilerplate to draw something on our
blank window.</p>
</article-content>
    <article-commit><p>Commit: <a href="https://github.com/phoekz/raydiance/commit/ff4c31c2c6c2039d33bfd07865448da963febfd6"><code>ff4c31c2</code></a></p></article-commit>
</article>
</section><hr>
    <footer>
        <footer-github><a href="https://github.com/phoekz/raydiance">GitHub</a></footer-github>
        <footer-copyright>© 2023 Vinh Truong</footer-copyright>
    </footer>
</body>
